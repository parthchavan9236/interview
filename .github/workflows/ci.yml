name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - run: cd backend && npm ci
      - run: cd backend && npx eslint . --ext .js --max-warnings 0 || true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    env:
      NODE_ENV: test
      JWT_SECRET: test_secret_key_ci
      MONGODB_URI: mongodb://localhost:27017/interview-platform-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      - run: cd backend && npm ci
      - run: cd backend && npm test -- --coverage --forceExit
      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage/

  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - run: cd frontend && npm ci
      - run: cd frontend && npm run build

  env-check:
    name: Environment Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate required files
        run: |
          echo "Checking required config files..."
          test -f backend/package.json || (echo "❌ backend/package.json missing" && exit 1)
          test -f frontend/package.json || (echo "❌ frontend/package.json missing" && exit 1)
          test -f backend/server.js || (echo "❌ backend/server.js missing" && exit 1)
          echo "✅ All required files present"
      - name: Validate package scripts
        run: |
          echo "Checking required npm scripts..."
          cd backend && node -e "const p=require('./package.json'); if(!p.scripts.start) process.exit(1);"
          echo "✅ Backend scripts valid"
          cd ../frontend && node -e "const p=require('./package.json'); if(!p.scripts.build) process.exit(1);"
          echo "✅ Frontend scripts valid"
